import { nothing } from 'lit';
import { getTemplateRenderingStrategy } from '@reddit/faceplate-ui/faceplateUIConfig.js';
import { defaultClasses, defaultStyles, imageClasses, imageStyle, onClickAction, } from '../attributes.js';
import { classMap, sanitizeDataUrl } from './util.js';
import { VerifiedPublicImageHosts, isDataUrl, isValidImageURL, } from '@devvit/shared-types/imageUtil.js';
const FALLBACK_IMG_URL = 'https://i.redd.it/p1vmc5ulmpib1.png';
export function renderImageBlock(block, ctx) {
    const { html, styleMap, ifDefined } = getTemplateRenderingStrategy();
    if (!block.config?.imageConfig) {
        console.error('Invalid block: Image missing ImageConfig');
        return nothing;
    }
    const { width, height, url, description, resizeMode } = block.config.imageConfig;
    let imageUrl = url;
    if (!isValidImageURL(imageUrl)) {
        console.error(`Invalid image URL: Image URL domain must be one of ${VerifiedPublicImageHosts.join(', ')}.`);
        // Replace url with a fallback snoo
        imageUrl = FALLBACK_IMG_URL;
    }
    else if (isDataUrl(imageUrl)) {
        const sanitized = sanitizeDataUrl(imageUrl);
        imageUrl = sanitized ?? FALLBACK_IMG_URL;
    }
    const classes = {
        ...defaultClasses(block, ctx),
        ...imageClasses(resizeMode),
    };
    const styles = {
        ...imageStyle(imageUrl, resizeMode, width, height),
        ...defaultStyles(block, ctx),
    };
    const onClick = onClickAction(block, ctx);
    return html `
    <div
      aria-description="${description}"
      class="${classMap(classes)}"
      style="${styleMap(styles)}"
      @click="${ifDefined(onClick)}"
      data-debug-block-type="image"
    >
      <img
        src="${imageUrl}"
        class="w-100 h-100"
        style="display: none"
        @error="${{
        handleEvent: (event) => {
            console.error(`Error loading image:`, imageUrl);
            event.target.src = FALLBACK_IMG_URL;
            event.target.style.display = 'block';
        },
        once: true,
    }}"
      />
    </div>
  `;
}
